<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bass Master Pro - Practice Station</title>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <style>
        :root { --bg: #f1f5f9; --primary: #2563eb; --accent: #e11d48; --card: #ffffff; --dark: #1e293b; --degree: #64748b; --scale-bg: #f8fafc; --success: #10b981; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; margin: 0; }
        .container { width: 100%; max-width: 1050px; }
        
        /* 1. ìƒë‹¨ ëŒ€ì‹œë³´ë“œ */
        .dashboard { display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px; margin-bottom: 20px; width: 100%; }
        .control-card { background: var(--dark); color: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; }
        .panel-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .label-text { font-size: 0.75rem; color: #94a3b8; font-weight: bold; margin-bottom: 5px; }
        .beat-selector { display: flex; gap: 8px; margin-top: 5px; }
        .beat-toggle { flex: 1; height: 35px; border-radius: 8px; border: none; background: var(--primary); color: white; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .beat-toggle.off { background: #475569; color: #94a3b8; opacity: 0.6; }
        .bpm-display, .timer-display { font-size: 1.8rem; font-weight: 800; color: #fbbf24; font-variant-numeric: tabular-nums; }
        .timer-display { color: var(--success); text-align: center; font-size: 2.2rem; }
        input[type=range] { flex: 1; cursor: pointer; }
        input[type=number] { background: #334155; border: 1px solid #475569; color: white; padding: 8px; border-radius: 8px; width: 60px; text-align: center; font-weight: bold; font-family: inherit; }
        select, .btn { padding: 8px 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-family: inherit; }
        .btn-main { background: var(--primary); color: white; flex: 1; height: 40px; }
        .btn-main.playing { background: var(--accent); }
        .btn-pdf { background: #64748b; color: white; font-size: 0.85rem; }

        /* 2. ì¤‘ì•™ ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        .main-layout { display: flex; gap: 30px; align-items: flex-start; width: 100%; margin-bottom: 20px; }
        .left-sidebar { flex: 0 0 350px; display: flex; flex-direction: column; gap: 20px; }
        .circle-container, .scale-container, .note-tab-container { background: var(--card); padding: 20px; border-radius: 20px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
        #circleOfFifths { width: 260px; height: 260px; cursor: pointer; }
        .key-node circle { fill: #f8fafc; stroke: #e2e8f0; stroke-width: 2; transition: 0.3s; }
        .key-node text.major-label { font-size: 14px; font-weight: bold; fill: var(--dark); pointer-events: none; text-anchor: middle; alignment-baseline: central; }
        .key-node text.minor-label { font-size: 10px; font-weight: 600; fill: var(--degree); pointer-events: none; text-anchor: middle; alignment-baseline: central; }
        .key-node.active circle { fill: var(--primary); stroke: var(--primary); }
        .key-node.active text.major-label { fill: #fff; }
        .key-node.active text.minor-label { fill: #bfdbfe; }
        
        .scale-result { background: var(--scale-bg); padding: 15px; border-radius: 12px; min-height: 60px; text-align: center; width: 100%; box-sizing: border-box;}
        .scale-notes { font-size: 1.3rem; font-weight: 800; color: var(--primary); letter-spacing: 1px; }

        .progression-board { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; flex: 1; }
        .measure-card { background: #fff; padding: 18px; border-radius: 15px; border: 1px solid #f1f5f9; border-left: 6px solid var(--primary); text-align: center; transition: 0.2s; }
        .measure-card.active-beat { transform: scale(1.02); border: 2px solid var(--accent); border-left: 10px solid var(--accent); box-shadow: 0 0 15px rgba(225, 29, 72, 0.2); }
        
        .chord-header { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; margin-bottom: 12px; }
        .chord-name { font-size: 1.7rem; font-weight: 800; color: var(--dark); }
        .original-notes { font-size: 0.95rem; font-weight: 600; color: #94a3b8; letter-spacing: 0.5px; }
        
        .notes-container { display: flex; justify-content: center; gap: 15px; margin-top: 10px; margin-bottom: 10px; }
        .note-name { font-size: 1.3rem; font-weight: 800; color: var(--accent); }
        .pattern-info { font-size: 0.75rem; color: #94a3b8; font-weight: 600; border-top: 1px solid #f1f5f9; padding-top: 8px; }

        /* íƒ­ ë…¸íŠ¸ ìŠ¤íƒ€ì¼ */
        .note-tab-container { align-items: flex-start; }
        .tab-header { display: flex; gap: 3px; margin-bottom: 10px; width: 100%; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; flex-wrap: wrap; }
        .tab-btn { background: #e2e8f0; color: var(--dark); border: none; padding: 5px 8px; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 0.7rem; font-weight: bold; transition: 0.2s; flex-grow: 1; text-align: center; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { width: 100%; }
        .note-area { width: 100%; height: 200px; border: 1px solid #e2e8f0; border-radius: 0 0 10px 10px; padding: 12px; font-family: inherit; font-size: 0.9rem; resize: none; display: none; box-sizing: border-box; outline: none; line-height: 1.5; }
        .note-area.active { display: block; }
        
        /* ì €ì¥ ë²„íŠ¼ ë ˆì´ì•„ì›ƒ */
        .save-controls { display: flex; gap: 8px; width: 100%; margin-top: 12px; }
        .btn-save { background: var(--success); color: white; flex: 1; font-size: 0.75rem; }
        .btn-export { background: #475569; color: white; flex: 1.5; font-size: 0.75rem; }

        /* ë“œë¡­ë°•ìŠ¤ ë™ê¸°í™” ì»¨íŠ¸ë¡¤ (ìˆ˜ì • ì‚¬í•­ 2: ìŠ¤íƒ€ì¼ ì¶”ê°€) */
        .cloud-controls { width: 100%; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #e2e8f0; }
        .cloud-row { display: flex; gap: 5px; margin-bottom: 8px; }
        #dbxToken { width: 100%; font-size: 0.65rem; padding: 5px; border-radius: 5px; border: 1px solid #cbd5e1; box-sizing: border-box; }
        .btn-cloud { font-size: 0.7rem; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; flex: 1; border: none; }
        .btn-dbx-save { background: #0061ff; color: white; }
        .btn-dbx-load { background: #f3f9ff; color: #0061ff; border: 1px solid #0061ff; }

        /* 3. í•˜ë‹¨ PDF ë·°ì–´ */
        .pdf-viewer-section { width: 100%; background: var(--card); border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); box-sizing: border-box; margin-top: 10px; }
        .pdf-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #pdfFrame { width: 100%; height: 600px; border: 1px solid #e2e8f0; border-radius: 10px; display: none; }
        .pdf-placeholder { width: 100%; height: 100px; border: 2px dashed #cbd5e1; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #94a3b8; }

        @media (max-width: 950px) {
            .main-layout, .dashboard { flex-direction: column; align-items: center; }
            .left-sidebar { width: 100%; flex: none; }
            .progression-board { width: 100%; }
            #circleOfFifths { width: 220px; height: 220px; }
            #pdfFrame { height: 450px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="dashboard">
        <div class="control-card">
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div class="label-text">GAP CLICK METRONOME</div>
                <div class="bpm-display" id="bpmValue">80 BPM</div>
            </div>
            <div class="panel-row">
                <input type="range" id="bpmRange" min="40" max="220" value="80">
            </div>
            <div class="beat-selector">
                <button class="beat-toggle off" data-beat="0">1</button>
                <button class="beat-toggle" data-beat="1">2</button>
                <button class="beat-toggle off" data-beat="2">3</button>
                <button class="beat-toggle" data-beat="3">4</button>
            </div>
            <div class="panel-row">
                <select id="noteResolution" style="flex:1.2;">
                    <option value="1">4ë¶„ (1/4)</option>
                    <option value="2">8ë¶„ (1/8)</option>
                    <option value="4">16ë¶„ (1/16)</option>
                </select>
                <button id="metroBtn" class="btn btn-main">START</button>
            </div>
        </div>

        <div class="control-card">
            <div class="label-text">CUSTOM PRACTICE TIMER</div>
            <div id="timerDisplay" class="timer-display">10:00</div>
            <div class="panel-row" style="justify-content: center;">
                <label for="timerInput" style="font-size: 0.8rem; color: #94a3b8;">Set Min:</label>
                <input type="number" id="timerInput" min="1" max="99" value="10">
            </div>
            <div class="panel-row">
                <button id="timerBtn" class="btn" style="background:var(--success); color:white; flex:2;">START</button>
                <button id="resetTimerBtn" class="btn" style="background:#475569; color:white; flex:1;">RESET</button>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <div class="left-sidebar">
            <div class="circle-container">
                <div style="font-weight: 800; margin-bottom: 10px;">â­• 5ë„ê¶Œ ìˆœí™˜í‘œ</div>
                <svg id="circleOfFifths" viewBox="0 0 300 300"></svg>
            </div>
            <div class="scale-container">
                <div style="font-weight: 800; margin-bottom: 10px;">ğŸ¹ ìŠ¤ì¼€ì¼ êµ¬ì„±ìŒ</div>
                <select id="scaleSelect" style="width:100%; margin-bottom:15px;">
                    <option disabled>â”€â”€ ê¸°ë³¸ & ëª¨ë˜ ìŠ¤ì¼€ì¼ â”€â”€</option>
                    <option value="majorPentatonic">Major Pentatonic (1 2 3 5 6)</option>
                    <option value="minorPentatonic">Minor Pentatonic (1 b3 4 5 b7)</option>
                    <option value="altered">Altered (1 b2 b3 b4 b5 b6 b7)</option>
                    <option value="jazzMinor">Jazz Minor (1 2 b3 4 5 6 7)</option>
                    <option value="wholeTone">Whole Tone Scale (1 2 3 #4 #5 b7)</option>
                    <option disabled>â”€â”€ 7ê°€ì§€ ëª¨ë“œ (Modes) â”€â”€</option>
                    <option value="ionian">Ionian (1 2 3 4 5 6 7)</option>
                    <option value="dorian">Dorian (1 2 b3 4 5 6 b7)</option>
                    <option value="phrygian">Phrygian (1 b2 b3 4 5 b6 b7)</option>
                    <option value="lydian">Lydian (1 2 3 #4 5 6 7)</option>
                    <option value="mixolydian">Mixolydian (1 2 3 4 5 6 b7)</option>
                    <option value="aeolian">Aeolian (1 2 b3 4 5 b6 b7)</option>
                    <option value="locrian">Locrian (1 b2 b3 b4 b5 b6 b7)</option>
                </select>
                <div class="scale-result">
                    <div id="scaleNotesDisplay" class="scale-notes">-</div>
                    <div id="scaleKeyLabel" style="font-size:0.75rem; color:var(--degree); margin-top:5px;">Select a Key</div>
                </div>
            </div>

            <div class="note-tab-container">
                <div style="font-weight: 800; margin-bottom: 10px;">ğŸ“ ì—°ìŠµ ë©”ëª¨</div>
                <div class="tab-header">
                    <button class="tab-btn active" data-tab="tab_goal">ëª©í‘œ</button>
                    <button class="tab-btn" data-tab="tab_memo">ë©”ëª¨</button>
                    <button class="tab-btn" data-tab="tab_groove">ê·¸ë£¨ë¸Œ</button>
                    <button class="tab-btn" data-tab="tab_chord">ì½”ë“œí†¤</button>
                    <button class="tab-btn" data-tab="tab_scale">ìŠ¤ì¼€ì¼</button>
                    <button class="tab-btn" data-tab="tab_penta">íœíƒ€</button>
                    <button class="tab-btn" data-tab="tab_tech">í…Œí¬ë‹‰</button>
                </div>
                <div class="tab-content">
                    <textarea id="tab_goal" class="note-area active" placeholder="ëª©í‘œ..."></textarea>
                    <textarea id="tab_memo" class="note-area" placeholder="ë©”ëª¨..."></textarea>
                    <textarea id="tab_groove" class="note-area" placeholder="ê·¸ë£¨ë¸Œ..."></textarea>
                    <textarea id="tab_chord" class="note-area" placeholder="ì½”ë“œí†¤..."></textarea>
                    <textarea id="tab_scale" class="note-area" placeholder="ìŠ¤ì¼€ì¼..."></textarea>
                    <textarea id="tab_penta" class="note-area" placeholder="íœíƒ€í† ë‹‰..."></textarea>
                    <textarea id="tab_tech" class="note-area" placeholder="í…Œí¬ë‹‰..."></textarea>
                </div>
                <div class="save-controls">
                    <button id="manualSaveBtn" class="btn btn-save">ì§€ê¸ˆ ì €ì¥</button>
                    <button id="exportBtn" class="btn btn-export">ë°±ì—… íŒŒì¼ ìƒì„± (.txt)</button>
                </div>
                <div class="cloud-controls">
                    <div class="label-text" style="color:#0061ff; margin-bottom: 5px;">â˜ï¸ DROPBOX SYNC</div>
                    <div class="cloud-row">
                        <input type="password" id="dbxToken" placeholder="Dropbox Access Token">
                    </div>
                    <div class="cloud-row">
                        <button id="dbxSaveBtn" class="btn-cloud btn-dbx-save">í´ë¼ìš°ë“œ ì €ì¥</button>
                        <button id="dbxLoadBtn" class="btn-cloud btn-dbx-load">í´ë¼ìš°ë“œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="progression-board" id="board"></div>
    </div>

    <div class="pdf-viewer-section">
        <div class="pdf-header">
            <div style="font-weight: 800; color: var(--dark);">ğŸ“„ ì—°ìŠµìš© ì•…ë³´ (PDF)</div>
            <input type="file" id="pdfInput" accept="application/pdf" style="display: none;">
            <button class="btn btn-pdf" onclick="document.getElementById('pdfInput').click()">ì•…ë³´ ì„ íƒ (.pdf)</button>
        </div>
        <div id="pdfPlaceholder" class="pdf-placeholder">
            <div>ì—°ìŠµí•  PDF íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
        </div>
        <iframe id="pdfFrame"></iframe>
    </div>
</div>

<script>
    // PDF ë¡œì§
    const pdfInput = document.getElementById('pdfInput'), pdfFrame = document.getElementById('pdfFrame'), pdfPlaceholder = document.getElementById('pdfPlaceholder');
    pdfInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type === 'application/pdf') {
            pdfFrame.src = URL.createObjectURL(file);
            pdfFrame.style.display = 'block'; pdfPlaceholder.style.display = 'none';
        }
    });

    const noteNames = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
    const circleOrder = [0, 7, 2, 9, 4, 11, 6, 1, 8, 3, 10, 5];
    let currentKeyRoot = 0;

    let audioCtx = null, isPlaying = false, currentBeat = 0, nextNoteTime = 0.0, timerID = null, bpm = 80, resolution = 1, totalElapsedBeats = 0;
    let beatMutes = [false, true, false, true]; 

    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

    function playClick(time, beat16) {
        if (!beatMutes[Math.floor(beat16 / 4)]) return;
        const osc = audioCtx.createOscillator(), env = audioCtx.createGain();
        osc.frequency.value = (beat16 === 0) ? 1000 : (beat16 % 4 === 0 ? 600 : 400);
        env.gain.setValueAtTime(0.2, time); env.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
        osc.connect(env); env.connect(audioCtx.destination);
        osc.start(time); osc.stop(time + 0.05);
    }

    function scheduler() {
        while (nextNoteTime < audioCtx.currentTime + 0.1) {
            if (currentBeat % (4 / resolution) === 0) playClick(nextNoteTime, currentBeat);
            if (currentBeat === 0) {
                const ms = document.querySelectorAll('.measure-card');
                ms.forEach(m => m.classList.remove('active-beat'));
                const idx = Math.floor(totalElapsedBeats / 16) % 8;
                if(ms[idx]) ms[idx].classList.add('active-beat');
            }
            nextNoteTime += (60.0 / bpm) / 4; currentBeat = (currentBeat + 1) % 16; totalElapsedBeats++;
        }
        timerID = setTimeout(scheduler, 25.0);
    }

    const metroBtn = document.getElementById('metroBtn');
    document.querySelectorAll('.beat-toggle').forEach(btn => {
        btn.onclick = () => {
            const idx = parseInt(btn.dataset.beat);
            beatMutes[idx] = !beatMutes[idx]; btn.classList.toggle('off', !beatMutes[idx]);
        };
    });

    metroBtn.onclick = function() {
        initAudio(); isPlaying = !isPlaying;
        if (isPlaying) {
            currentBeat = 0; totalElapsedBeats = 0; nextNoteTime = audioCtx.currentTime;
            scheduler(); this.innerText = "STOP"; this.classList.add('playing');
        } else {
            clearTimeout(timerID); this.innerText = "START"; this.classList.remove('playing');
            document.querySelectorAll('.measure-card').forEach(m => m.classList.remove('active-beat'));
        }
    };

    document.getElementById('bpmRange').oninput = (e) => {
        bpm = e.target.value; document.getElementById('bpmValue').innerText = `${bpm} BPM`;
    };
    document.getElementById('noteResolution').onchange = (e) => resolution = parseInt(e.target.value);

    let timeLeft = 600, timerRunning = false, timerInterval = null;
    function updateTimer() {
        const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        document.getElementById('timerDisplay').innerText = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    document.getElementById('timerInput').oninput = function() {
        if (!timerRunning) { timeLeft = parseInt(this.value) * 60; updateTimer(); }
    };

    document.getElementById('timerBtn').onclick = function() {
        if (timerRunning) { clearInterval(timerInterval); this.innerText = "START"; this.style.background = "var(--success)"; }
        else {
            timerInterval = setInterval(() => {
                if (timeLeft > 0) { timeLeft--; updateTimer(); }
                else { clearInterval(timerInterval); timerRunning = false; alert("ì—°ìŠµ ì¢…ë£Œ!"); }
            }, 1000);
            this.innerText = "PAUSE"; this.style.background = "#f59e0b";
        }
        timerRunning = !timerRunning;
    };

    document.getElementById('resetTimerBtn').onclick = () => {
        clearInterval(timerInterval); timerRunning = false;
        timeLeft = parseInt(document.getElementById('timerInput').value) * 60;
        updateTimer(); document.getElementById('timerBtn').innerText = "START";
    };

    const scaleForms = {
        majorPentatonic: [0, 2, 4, 7, 9], 
        minorPentatonic: [0, 3, 5, 7, 10], 
        altered: [0, 1, 3, 4, 6, 8, 10],
        jazzMinor: [0, 2, 3, 5, 7, 9, 11], 
        wholeTone: [0, 2, 4, 6, 8, 10],
        ionian: [0, 2, 4, 5, 7, 9, 11],
        dorian: [0, 2, 3, 5, 7, 9, 10], 
        phrygian: [0, 1, 3, 5, 7, 8, 10],
        lydian: [0, 2, 4, 6, 7, 9, 11],
        mixolydian: [0, 2, 4, 5, 7, 9, 10],
        aeolian: [0, 2, 3, 5, 7, 8, 10],
        locrian: [0, 1, 3, 5, 6, 8, 10]
    };

    const progressionPattern = [
        { interval: 0, type: 'M7', label: 'I', deg2: 2 }, { interval: 5, type: 'M7', label: 'IV', deg2: 2 },
        { interval: 11, type: 'm7b5', label: 'viiÃ¸', deg2: 1 }, { interval: 4, type: 'm7', label: 'iii', deg2: 1 },
        { interval: 9, type: 'm7', label: 'vi', deg2: 2 }, { interval: 2, type: 'm7', label: 'ii', deg2: 2 },
        { interval: 7, type: '7', label: 'V', deg2: 2 }, { interval: 0, type: 'M7', label: 'I', deg2: 2 }
    ];
    const forms = { 'M7': [0, 4, 7, 11], 'm7': [0, 3, 7, 10], '7': [0, 4, 7, 10], 'm7b5': [0, 3, 6, 10] };

    function initCircle() {
        const svg = document.getElementById('circleOfFifths');
        circleOrder.forEach((n, i) => {
            const angle = (i * 30 - 90) * (Math.PI / 180);
            const xMajor = 150 + 105 * Math.cos(angle);
            const yMajor = 150 + 105 * Math.sin(angle);
            const xMinor = 150 + 72 * Math.cos(angle);
            const yMinor = 150 + 72 * Math.sin(angle);
            const minorIdx = (n + 9) % 12;

            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("class", "key-node"); g.id = "node-" + n;
            g.onclick = () => updateKey(n);
            
            const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            c.setAttribute("cx", xMajor); c.setAttribute("cy", yMajor); c.setAttribute("r", 20);
            
            const tMajor = document.createElementNS("http://www.w3.org/2000/svg", "text");
            tMajor.setAttribute("x", xMajor); tMajor.setAttribute("y", yMajor); 
            tMajor.setAttribute("class", "major-label");
            tMajor.textContent = noteNames[n];

            const tMinor = document.createElementNS("http://www.w3.org/2000/svg", "text");
            tMinor.setAttribute("x", xMinor); tMinor.setAttribute("y", yMinor); 
            tMinor.setAttribute("class", "minor-label");
            tMinor.textContent = noteNames[minorIdx] + "m";

            g.append(c, tMajor, tMinor); 
            svg.append(g);
        });
    }

    function updateKey(val) {
        document.querySelectorAll('.key-node').forEach(n => n.classList.remove('active'));
        document.getElementById('node-' + val).classList.add('active');
        currentKeyRoot = parseInt(val); renderProgression(currentKeyRoot); renderScale();
    }

    function renderScale() {
        const scaleType = document.getElementById('scaleSelect').value;
        const notes = scaleForms[scaleType].map(f => noteNames[(currentKeyRoot + f) % 12]);
        document.getElementById('scaleNotesDisplay').innerText = notes.join(' ');
        document.getElementById('scaleKeyLabel').innerText = `Key: ${noteNames[currentKeyRoot]}`;
    }

    function renderProgression(keyRoot) {
        const board = document.getElementById('board'); board.innerHTML = '';
        progressionPattern.forEach((p, idx) => {
            const rIdx = (keyRoot + p.interval) % 12, cName = noteNames[rIdx] + (p.type === 'm7b5' ? 'm7b5' : p.type);
            const tones = forms[p.type].map(f => noteNames[(rIdx + f) % 12]); 
            const root = noteNames[rIdx], third = tones[1], fifth = tones[2], seventh = tones[3];
            const patternIdx = (idx + 1) % 2 !== 0 ? '3-2-1-7' : '3-5-1-7';
            let data = ((idx + 1) % 2 !== 0) 
                ? [{d:'3',n:third},{d:'2',n:noteNames[(rIdx+p.deg2)%12]},{d:'1',n:root},{d:'7',n:seventh}] 
                : [{d:'3',n:third},{d:'5',n:fifth},{d:'1',n:root},{d:'7',n:seventh}];

            const card = document.createElement('div'); card.className = 'measure-card';
            card.innerHTML = `
                <div style="font-size:0.7rem; color:#94a3b8;">BAR ${idx + 1} (${p.label})</div>
                <div class="chord-header">
                    <div class="chord-name">${cName}</div>
                    <div class="original-notes">(${tones.join(' ')})</div>
                </div>
                <div class="notes-container">${data.map(d => `<div style="text-align:center;"><div style="font-size:0.7rem; color:var(--degree);">${d.d}</div><div class="note-name">${d.n}</div></div>`).join('')}</div>
                <div class="pattern-info">Pattern: ${patternIdx}</div>`;
            board.appendChild(card);
        });
    }

    const tabs = document.querySelectorAll('.tab-btn');
    const noteAreas = document.querySelectorAll('.note-area');

    tabs.forEach(tab => {
        tab.onclick = () => {
            tabs.forEach(t => t.classList.remove('active'));
            noteAreas.forEach(n => n.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        };
    });

    noteAreas.forEach(area => {
        area.value = localStorage.getItem('bassMaster_' + area.id) || "";
        area.oninput = () => {
            localStorage.setItem('bassMaster_' + area.id, area.value);
        };
    });

    document.getElementById('manualSaveBtn').onclick = function() {
        noteAreas.forEach(area => localStorage.setItem('bassMaster_' + area.id, area.value));
        const originalText = this.innerText;
        this.innerText = "ì €ì¥ ì™„ë£Œ! âœ…";
        this.style.background = "#059669";
        setTimeout(() => {
            this.innerText = originalText;
            this.style.background = "var(--success)";
        }, 1500);
    };

    document.getElementById('exportBtn').onclick = () => {
        let exportData = "=== BASS MASTER PRACTICE NOTES ===\n\n";
        tabs.forEach(tab => {
            const area = document.getElementById(tab.dataset.tab);
            exportData += `[${tab.innerText}]\n${area.value}\n\n`;
        });
        
        const blob = new Blob([exportData], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Bass_Practice_${new Date().toISOString().slice(0, 10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // --- ë“œë¡­ë°•ìŠ¤ ë™ê¸°í™” ë¡œì§ (ìˆ˜ì • ì‚¬í•­ 4: ë¡œì§ ì¶”ê°€) ---
    const DBX_FILE_PATH = '/bass_practice_notes.json';
    const dbxTokenInput = document.getElementById('dbxToken');

    // í† í°ì„ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ì—¬ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©
    dbxTokenInput.value = localStorage.getItem('dbx_access_token') || "";
    dbxTokenInput.onchange = (e) => localStorage.setItem('dbx_access_token', e.target.value);

    function getDbx() {
        const token = localStorage.getItem('dbx_access_token');
        if (!token) { alert("ë“œë¡­ë°•ìŠ¤ í† í°ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!"); return null; }
        return new Dropbox.Dropbox({ accessToken: token });
    }

    document.getElementById('dbxSaveBtn').onclick = async function() {
        const dbx = getDbx(); if (!dbx) return;
        const originalText = this.innerText;
        this.innerText = "ì €ì¥ ì¤‘...";
        
        const dataToSave = {};
        noteAreas.forEach(area => dataToSave[area.id] = area.value);
        
        try {
            await dbx.filesUpload({
                path: DBX_FILE_PATH,
                contents: JSON.stringify(dataToSave),
                mode: 'overwrite'
            });
            alert("ë“œë¡­ë°•ìŠ¤ ì €ì¥ ì™„ë£Œ!");
        } catch (e) {
            console.error(e);
            alert("ì €ì¥ ì‹¤íŒ¨. í† í°ì´ë‚˜ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
        } finally {
            this.innerText = originalText;
        }
    };

    document.getElementById('dbxLoadBtn').onclick = async function() {
        const dbx = getDbx(); if (!dbx) return;
        const originalText = this.innerText;
        this.innerText = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        
        try {
            const response = await dbx.filesDownload({ path: DBX_FILE_PATH });
            const text = await response.result.fileBlob.text();
            const data = JSON.parse(text);
            
            Object.keys(data).forEach(id => {
                const area = document.getElementById(id);
                if (area) {
                    area.value = data[id];
                    localStorage.setItem('bassMaster_' + id, data[id]);
                }
            });
            alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
        } catch (e) {
            console.error(e);
            alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨. íŒŒì¼ì´ ì—†ê±°ë‚˜ í† í° ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
        } finally {
            this.innerText = originalText;
        }
    };

    document.getElementById('scaleSelect').onchange = renderScale;
    window.onload = () => { initCircle(); updateKey(0); updateTimer(); };
</script>

</body>
</html>
