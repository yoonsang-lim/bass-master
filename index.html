<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bass Master Pro - Cloud Station</title>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <style>
        :root { --bg: #f1f5f9; --primary: #2563eb; --accent: #e11d48; --card: #ffffff; --dark: #1e293b; --degree: #64748b; --scale-bg: #f8fafc; --success: #10b981; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; margin: 0; }
        .container { width: 100%; max-width: 1050px; }
        
        /* 1. ìƒë‹¨ ëŒ€ì‹œë³´ë“œ */
        .dashboard { display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px; margin-bottom: 20px; width: 100%; }
        .control-card { background: var(--dark); color: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; }
        .panel-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .label-text { font-size: 0.75rem; color: #94a3b8; font-weight: bold; margin-bottom: 5px; }
        .beat-selector { display: flex; gap: 8px; margin-top: 5px; }
        .beat-toggle { flex: 1; height: 35px; border-radius: 8px; border: none; background: var(--primary); color: white; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .beat-toggle.off { background: #475569; color: #94a3b8; opacity: 0.6; }
        .bpm-display, .timer-display { font-size: 1.8rem; font-weight: 800; color: #fbbf24; font-variant-numeric: tabular-nums; }
        .timer-display { color: var(--success); text-align: center; font-size: 2.2rem; }
        input[type=range] { flex: 1; cursor: pointer; }
        input[type=number] { background: #334155; border: 1px solid #475569; color: white; padding: 8px; border-radius: 8px; width: 60px; text-align: center; font-weight: bold; font-family: inherit; }
        select, .btn { padding: 8px 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-family: inherit; }
        .btn-main { background: var(--primary); color: white; flex: 1; height: 40px; }
        .btn-main.playing { background: var(--accent); }
        .btn-pdf { background: #64748b; color: white; font-size: 0.85rem; }

        /* 2. ì¤‘ì•™ ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        .main-layout { display: flex; gap: 30px; align-items: flex-start; width: 100%; margin-bottom: 20px; }
        .left-sidebar { flex: 0 0 350px; display: flex; flex-direction: column; gap: 20px; }
        .circle-container, .scale-container, .note-tab-container { background: var(--card); padding: 20px; border-radius: 20px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
        #circleOfFifths { width: 260px; height: 260px; cursor: pointer; }
        .key-node circle { fill: #f8fafc; stroke: #e2e8f0; stroke-width: 2; transition: 0.3s; }
        .key-node text.major-label { font-size: 14px; font-weight: bold; fill: var(--dark); pointer-events: none; text-anchor: middle; alignment-baseline: central; }
        .key-node text.minor-label { font-size: 10px; font-weight: 600; fill: var(--degree); pointer-events: none; text-anchor: middle; alignment-baseline: central; }
        .key-node.active circle { fill: var(--primary); stroke: var(--primary); }
        .key-node.active text.major-label { fill: #fff; }
        .key-node.active text.minor-label { fill: #bfdbfe; }
        
        .scale-result { background: var(--scale-bg); padding: 15px; border-radius: 12px; min-height: 60px; text-align: center; width: 100%; box-sizing: border-box;}
        .scale-notes { font-size: 1.3rem; font-weight: 800; color: var(--primary); letter-spacing: 1px; }

        .progression-board { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; flex: 1; }
        .measure-card { background: #fff; padding: 18px; border-radius: 15px; border: 1px solid #f1f5f9; border-left: 6px solid var(--primary); text-align: center; transition: 0.2s; }
        .measure-card.active-beat { transform: scale(1.02); border: 2px solid var(--accent); border-left: 10px solid var(--accent); box-shadow: 0 0 15px rgba(225, 29, 72, 0.2); }
        
        /* íƒ­ ë…¸íŠ¸ ìŠ¤íƒ€ì¼ */
        .tab-header { display: flex; gap: 3px; margin-bottom: 10px; width: 100%; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; flex-wrap: wrap; }
        .tab-btn { background: #e2e8f0; color: var(--dark); border: none; padding: 5px 8px; border-radius: 6px 6px 0 0; cursor: pointer; font-size: 0.7rem; font-weight: bold; transition: 0.2s; flex-grow: 1; text-align: center; }
        .tab-btn.active { background: var(--primary); color: white; }
        .note-area { width: 100%; height: 200px; border: 1px solid #e2e8f0; border-radius: 0 0 10px 10px; padding: 12px; font-family: inherit; font-size: 0.9rem; resize: none; display: none; box-sizing: border-box; outline: none; line-height: 1.5; }
        .note-area.active { display: block; }
        
        /* í´ë¼ìš°ë“œ ì €ì¥ ì»¨íŠ¸ë¡¤ */
        .cloud-controls { width: 100%; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #e2e8f0; }
        .cloud-row { display: flex; gap: 5px; margin-bottom: 8px; }
        #dbxToken { width: 100%; font-size: 0.65rem; padding: 5px; border-radius: 5px; border: 1px solid #cbd5e1; }
        .btn-cloud { font-size: 0.7rem; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; flex: 1; }
        .btn-dbx-save { background: #0061ff; color: white; border: none; }
        .btn-dbx-load { background: #f3f9ff; color: #0061ff; border: 1px solid #0061ff; }

        /* í•˜ë‹¨ PDF */
        .pdf-viewer-section { width: 100%; background: var(--card); border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-top: 10px; }
        #pdfFrame { width: 100%; height: 600px; border: 1px solid #e2e8f0; border-radius: 10px; display: none; }

        @media (max-width: 950px) {
            .main-layout, .dashboard { flex-direction: column; align-items: center; }
            .left-sidebar { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="dashboard">
        <div class="control-card">
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div class="label-text">GAP CLICK METRONOME</div>
                <div id="bpmValue" class="bpm-display">80 BPM</div>
            </div>
            <div class="panel-row"><input type="range" id="bpmRange" min="40" max="220" value="80"></div>
            <div class="beat-selector">
                <button class="beat-toggle off" data-beat="0">1</button>
                <button class="beat-toggle" data-beat="1">2</button>
                <button class="beat-toggle off" data-beat="2">3</button>
                <button class="beat-toggle" data-beat="3">4</button>
            </div>
            <div class="panel-row">
                <select id="noteResolution" style="flex:1.2;">
                    <option value="1">4ë¶„</option><option value="2">8ë¶„</option><option value="4">16ë¶„</option>
                </select>
                <button id="metroBtn" class="btn btn-main">START</button>
            </div>
        </div>
        <div class="control-card">
            <div id="timerDisplay" class="timer-display">10:00</div>
            <div class="panel-row"><input type="number" id="timerInput" min="1" max="99" value="10"></div>
            <div class="panel-row">
                <button id="timerBtn" class="btn" style="background:var(--success); color:white; flex:2;">START</button>
                <button id="resetTimerBtn" class="btn" style="background:#475569; color:white; flex:1;">RESET</button>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <div class="left-sidebar">
            <div class="circle-container">
                <div style="font-weight: 800; margin-bottom: 10px;">â­• 5ë„ê¶Œ ìˆœí™˜í‘œ</div>
                <svg id="circleOfFifths" viewBox="0 0 300 300"></svg>
            </div>
            <div class="scale-container">
                <div style="font-weight: 800; margin-bottom: 10px;">ğŸ¹ ìŠ¤ì¼€ì¼ êµ¬ì„±ìŒ</div>
                <select id="scaleSelect" style="width:100%; margin-bottom:15px;">
                    <option value="majorPentatonic">Major Pentatonic</option>
                    <option value="minorPentatonic">Minor Pentatonic</option>
                    <option value="wholeTone">Whole Tone Scale</option>
                    <option disabled>â”€â”€ 7ê°€ì§€ ëª¨ë“œ â”€â”€</option>
                    <option value="ionian">Ionian</option><option value="dorian">Dorian</option>
                    <option value="phrygian">Phrygian</option><option value="lydian">Lydian</option>
                    <option value="mixolydian">Mixolydian</option><option value="aeolian">Aeolian</option>
                    <option value="locrian">Locrian</option>
                </select>
                <div class="scale-result"><div id="scaleNotesDisplay" class="scale-notes">-</div></div>
            </div>

            <div class="note-tab-container">
                <div class="tab-header">
                    <button class="tab-btn active" data-tab="tab_goal">ëª©í‘œ</button>
                    <button class="tab-btn" data-tab="tab_memo">ë©”ëª¨</button>
                    <button class="tab-btn" data-tab="tab_groove">ê·¸ë£¨ë¸Œ</button>
                    <button class="tab-btn" data-tab="tab_chord">ì½”ë“œí†¤</button>
                    <button class="tab-btn" data-tab="tab_scale">ìŠ¤ì¼€ì¼</button>
                    <button class="tab-btn" data-tab="tab_penta">íœíƒ€</button>
                    <button class="tab-btn" data-tab="tab_tech">í…Œí¬ë‹‰</button>
                </div>
                <div class="tab-content">
                    <textarea id="tab_goal" class="note-area active" placeholder="ëª©í‘œ..."></textarea>
                    <textarea id="tab_memo" class="note-area" placeholder="ë©”ëª¨..."></textarea>
                    <textarea id="tab_groove" class="note-area" placeholder="ê·¸ë£¨ë¸Œ..."></textarea>
                    <textarea id="tab_chord" class="note-area" placeholder="ì½”ë“œí†¤..."></textarea>
                    <textarea id="tab_scale" class="note-area" placeholder="ìŠ¤ì¼€ì¼..."></textarea>
                    <textarea id="tab_penta" class="note-area" placeholder="íœíƒ€..."></textarea>
                    <textarea id="tab_tech" class="note-area" placeholder="í…Œí¬ë‹‰..."></textarea>
                </div>

                <div class="cloud-controls">
                    <div class="label-text" style="color:#0061ff">â˜ï¸ DROPBOX SYNC</div>
                    <input type="password" id="dbxToken" placeholder="Paste Dropbox Access Token Here">
                    <div class="cloud-row">
                        <button id="dbxSaveBtn" class="btn-cloud btn-dbx-save">ê¸°ê¸° ë°ì´í„° â†’ í´ë¼ìš°ë“œ ì €ì¥</button>
                        <button id="dbxLoadBtn" class="btn-cloud btn-dbx-load">í´ë¼ìš°ë“œ â†’ í˜„ì¬ ê¸°ê¸°ë¡œ ë¡œë“œ</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="progression-board" id="board"></div>
    </div>

    <div class="pdf-viewer-section">
        <button class="btn btn-pdf" onclick="document.getElementById('pdfInput').click()">ì•…ë³´ ì„ íƒ (.pdf)</button>
        <input type="file" id="pdfInput" accept="application/pdf" style="display: none;">
        <iframe id="pdfFrame"></iframe>
    </div>
</div>

<script>
    // --- ğŸ†• ë“œë¡­ë°•ìŠ¤ ì—°ë™ ë¡œì§ ---
    const DBX_FILE_PATH = '/bass_practice_notes.json';
    const dbxTokenInput = document.getElementById('dbxToken');

    // í† í°ì€ ë³´ì•ˆìƒ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ë§Œ ì €ì¥
    dbxTokenInput.value = localStorage.getItem('dbx_access_token') || "";
    dbxTokenInput.onchange = (e) => localStorage.setItem('dbx_access_token', e.target.value);

    function getDbx() {
        const token = localStorage.getItem('dbx_access_token');
        if (!token) { alert("ë“œë¡­ë°•ìŠ¤ í† í°ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!"); return null; }
        return new Dropbox.Dropbox({ accessToken: token });
    }

    // í´ë¼ìš°ë“œë¡œ ì €ì¥
    document.getElementById('dbxSaveBtn').onclick = async function() {
        const dbx = getDbx(); if (!dbx) return;
        this.innerText = "ì €ì¥ ì¤‘...";
        
        const dataToSave = {};
        noteAreas.forEach(area => dataToSave[area.id] = area.value);
        
        try {
            await dbx.filesUpload({
                path: DBX_FILE_PATH,
                contents: JSON.stringify(dataToSave),
                mode: 'overwrite'
            });
            alert("ë“œë¡­ë°•ìŠ¤ ì €ì¥ ì™„ë£Œ! ì´ì œ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        } catch (e) { console.error(e); alert("ì €ì¥ ì‹¤íŒ¨. í† í°ì„ í™•ì¸í•˜ì„¸ìš”."); }
        finally { this.innerText = "ê¸°ê¸° ë°ì´í„° â†’ í´ë¼ìš°ë“œ ì €ì¥"; }
    };

    // í´ë¼ìš°ë“œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    document.getElementById('dbxLoadBtn').onclick = async function() {
        const dbx = getDbx(); if (!dbx) return;
        this.innerText = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        
        try {
            const response = await dbx.filesDownload({ path: DBX_FILE_PATH });
            const text = await response.result.fileBlob.text();
            const data = JSON.parse(text);
            
            Object.keys(data).forEach(id => {
                const area = document.getElementById(id);
                if (area) {
                    area.value = data[id];
                    localStorage.setItem('bassMaster_' + id, data[id]);
                }
            });
            alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! ë°ì´í„°ê°€ ìµœì‹  ìƒíƒœë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) { console.error(e); alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨. íŒŒì¼ì´ ì—†ê±°ë‚˜ í† í° ì˜¤ë¥˜ì…ë‹ˆë‹¤."); }
        finally { this.innerText = "í´ë¼ìš°ë“œ â†’ í˜„ì¬ ê¸°ê¸°ë¡œ ë¡œë“œ"; }
    };

    // --- ê¸°ì¡´ ë¡œì§ (ìˆ˜ì • ê¸ˆì§€ ì˜ì—­) ---
    const noteNames = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
    const circleOrder = [0, 7, 2, 9, 4, 11, 6, 1, 8, 3, 10, 5];
    let currentKeyRoot = 0;
    const scaleForms = {
        majorPentatonic: [0, 2, 4, 7, 9], minorPentatonic: [0, 3, 5, 7, 10], wholeTone: [0, 2, 4, 6, 8, 10],
        ionian: [0, 2, 4, 5, 7, 9, 11], dorian: [0, 2, 3, 5, 7, 9, 10], phrygian: [0, 1, 3, 5, 7, 8, 10],
        lydian: [0, 2, 4, 6, 7, 9, 11], mixolydian: [0, 2, 4, 5, 7, 9, 10], aeolian: [0, 2, 3, 5, 7, 8, 10], locrian: [0, 1, 3, 5, 6, 8, 10]
    };
    const progressionPattern = [{ i: 0, t: 'M7', l: 'I' }, { i: 5, t: 'M7', l: 'IV' }, { i: 11, t: 'm7b5', l: 'viiÃ¸' }, { i: 4, t: 'm7', l: 'iii' }, { i: 9, t: 'm7', l: 'vi' }, { i: 2, t: 'm7', l: 'ii' }, { i: 7, t: '7', l: 'V' }, { i: 0, t: 'M7', l: 'I' }];

    function initCircle() {
        const svg = document.getElementById('circleOfFifths');
        circleOrder.forEach((n, i) => {
            const angle = (i * 30 - 90) * (Math.PI / 180);
            const x = 150 + 105 * Math.cos(angle), y = 150 + 105 * Math.sin(angle);
            const xm = 150 + 72 * Math.cos(angle), ym = 150 + 72 * Math.sin(angle);
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("class", "key-node"); g.id = "node-" + n; g.onclick = () => updateKey(n);
            const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            c.setAttribute("cx", x); c.setAttribute("cy", y); c.setAttribute("r", 20);
            const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
            t.setAttribute("x", x); t.setAttribute("y", y); t.setAttribute("class", "major-label"); t.textContent = noteNames[n];
            const tm = document.createElementNS("http://www.w3.org/2000/svg", "text");
            tm.setAttribute("x", xm); tm.setAttribute("y", ym); tm.setAttribute("class", "minor-label"); tm.textContent = noteNames[(n + 9) % 12] + "m";
            g.append(c, t, tm); svg.append(g);
        });
    }

    function updateKey(val) {
        document.querySelectorAll('.key-node').forEach(n => n.classList.remove('active'));
        document.getElementById('node-' + val).classList.add('active');
        currentKeyRoot = val; renderProgression(val); renderScale();
    }

    function renderScale() {
        const type = document.getElementById('scaleSelect').value;
        const notes = scaleForms[type].map(f => noteNames[(currentKeyRoot + f) % 12]);
        document.getElementById('scaleNotesDisplay').innerText = notes.join(' ');
    }

    function renderProgression(keyRoot) {
        const board = document.getElementById('board'); board.innerHTML = '';
        progressionPattern.forEach((p, idx) => {
            const rIdx = (keyRoot + p.i) % 12;
            const card = document.createElement('div'); card.className = 'measure-card';
            card.innerHTML = `<div style="font-size:0.7rem; color:#94a3b8;">${p.l}</div><div class="chord-name">${noteNames[rIdx]}${p.t}</div>`;
            board.appendChild(card);
        });
    }

    const tabs = document.querySelectorAll('.tab-btn');
    const noteAreas = document.querySelectorAll('.note-area');
    tabs.forEach(tab => {
        tab.onclick = () => {
            tabs.forEach(t => t.classList.remove('active')); noteAreas.forEach(n => n.classList.remove('active'));
            tab.classList.add('active'); document.getElementById(tab.dataset.tab).classList.add('active');
        };
    });

    noteAreas.forEach(area => {
        area.value = localStorage.getItem('bassMaster_' + area.id) || "";
        area.oninput = () => localStorage.setItem('bassMaster_' + area.id, area.value);
    });

    // ë©”íŠ¸ë¡œë†ˆ/íƒ€ì´ë¨¸ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
    let audioCtx = null, isPlaying = false, currentBeat = 0, nextNoteTime = 0, timerID = null;
    document.getElementById('metroBtn').onclick = function() {
        if (!audioCtx) audioCtx = new AudioContext(); isPlaying = !isPlaying;
        if (isPlaying) { nextNoteTime = audioCtx.currentTime; scheduler(); this.innerText = "STOP"; } else { clearTimeout(timerID); this.innerText = "START"; }
    };
    function scheduler() {
        while (nextNoteTime < audioCtx.currentTime + 0.1) {
            const osc = audioCtx.createOscillator(); const env = audioCtx.createGain();
            osc.frequency.value = currentBeat === 0 ? 1000 : 500; env.gain.value = 0.1;
            osc.connect(env); env.connect(audioCtx.destination); osc.start(nextNoteTime); osc.stop(nextNoteTime + 0.05);
            nextNoteTime += 60 / document.getElementById('bpmRange').value; currentBeat = (currentBeat + 1) % 4;
        }
        timerID = setTimeout(scheduler, 25);
    }
    document.getElementById('bpmRange').oninput = (e) => document.getElementById('bpmValue').innerText = e.target.value + " BPM";

    window.onload = () => { initCircle(); updateKey(0); };
</script>

</body>
</html>
